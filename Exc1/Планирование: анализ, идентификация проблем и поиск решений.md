# Анализ схемы и описание системы
Система состоит из 3 основных функциональных компонентов:
- Онлайн-магазин
- CRM-система
- MES-система

А так же 3 инфраструктурных:
- PostgreSQL
- S3-файловое хранилище
- RabbitMQ

## Жалобы пользователей
Не получили заказ и над их изделием работают уже несколько месяцев, хотя обещали закончить за 3 недели. После внедрения асинхронного взаимодействия между MES и CRM, жалоб стало больше.

Возможные причины:
- Онлайн-магазин: пользователь нажимает кнопку "Сделать заказ", далее продавец видимо запрашивает подтверждение с стоимостью заказа по телефону или другим каналам связи, далее пользовтель не знает о статусе заказа, данную проблему можно решить внедрив функцию уведомлений о статусе заказа пользователя.
- Производственные мощности: заказ задерживается по производственной причине, данная причина не берется во внимание т.к. по вводным производственные мощности позволяют справиться с заказами и могут обеспечить двукратный рост.
- Shop DB: база данных используется двумя сервисами, ведет к неконсистентности данных и возможным багам.
- RabbitMQ: обеспечивает асинхронное взаимодействие между CRM и MES, но т.к. нет мониторинга сервисов CRM API/MES API и RabbitMQ, данное асинхронное взаимодействие может приводить к потери (конфигурация очереди без подтверждения) и/или задержкам(накопилась очередь) заказов в зависимости от нагрузки как самих сервисов CRM API/MES API так и RabbitMQ.
- CRM-система: продавцы подтверждают заказ и передают в производство с задержкой т.к. процесс подтверждения заказа не автоматизирован.
- MES-система: медленная работа операторов по причине неудовлетварительной работы MES-системы, например ошибки работы приводящие к потери заказов, медленная загрузка данных и т.д.


## Жалобы операторов
Когда операторы заходят на первую страницу MES, система долго прогружается.

Возможные причины:
- MES: не оптимизирован фронтенд, хотя сделали пагинацию и фильтрацию но фронтендер знает React только частично, не исключены ошибки в реализации.
- MES API: возможно высокая нагрузка на сервис в следствии наличия как внутренних API, так и внешних.
- MES API: возможно высокая нагрузка на сервис в следствии наличия функционала расчета стоимости.
- MES DB: не оптимизированы запросы, индексы

## Жалобы других продавцов
Не получают заказы. Другие продавцы через MES API рассчитывают стоимость изделия и создается заказ в CRM системе по асинхронному взаимодействию (через RabbitMQ).

Возможные причины:
- MES API: возможно высокая нагрузка на сервис в следствии наличия как внутренних API, так и внешних.
- MES API: возможно высокая нагрузка на сервис в следствии наличия функционала расчета стоимости.
- MES DB: не оптимизированы запросы, индексы.
- Shop DB: база данных используется двумя сервисами, ведет к неконсистентности данных и возможным багам на стороне SHOP API / CRM API.
- RabbitMQ: обеспечивает асинхронное взаимодействие между CRM и MES, но т.к. нет мониторинга сервисов CRM API/MES API и RabbitMQ, данное асинхронное взаимодействие может приводить к потери (конфигурация очереди без подтверждения) и/или задержкам(накопилась очередь) заказов в зависимости от нагрузки как самих сервисов CRM API/MES API так и RabbitMQ.
- CRM-система: продавцы подтверждают заказ и передают в производство с задержкой т.к. процесс подтверждения заказа не автоматизирован.


## Общие замечания

1. Из исходной схемы видно нарушение принципа единственной отвественности (далее SRP), в части MES-системы. А точнее MES-система отвечающая за управление производством принимает по публичному API заказы от других продавцов ювелирных изделий. Из-за нарушения данного принципа и происходит неконтролируемая нагрузка на сервис, которая мешает работе системе отвечающей за управление производством (жалобы Операторов), возможны проблемы с безопасностью, так же усложняется развитие сервиса из-за наличия API для внешних и внутренних пользователей.
2. MES API фактически монолит, т.к. кроме выполнения пользовательских функций в него заложена функция рассчета стоимости заказа, а так же реализован публичный API для внешних пользователей.
2. CRM API использует базу данных Онлайн-магазина, это нарушает принцип "База данных на сервис (Database Per Service)" и SRP, потенциально это может привести к нарушению бизнес-логики, т.к. только Shop API знает как правильно работать с его данными, и какая бизнес-логика применяется при получении и обработки этих данных. Так же усложняется изменение и развитие сервиса Онлайн-магазина из-за данной зависимости.
3. Есть Unit-тесты, но нет автоматизированных интеграционных и нагрузочных тестов, соответственно скорее всего по этой причине деплой производиться вручную.
4. Не хватает еще одного окружения: test.
5. Деплой производится вручную.
6. Не достаточно в команде компетенций по React, так же есть риск по бэкенду Java т.к. тимплид бывший разработчки C#.



# Разработка инициатив, для устранения нежелательных ситуаций
Каждая инициатива имеет приоритет по Матрице Эйзенхауэра.

## (срочно-важно) Инициатива №1:
Внедрение мониторинга USE для RabbitMQ, S3 хранилище, баз данных PostgreSQL для определения "бутылочных горлышек" в текущей архитектуре.
Внедрение мониторинга RED(D - включает трассировку) для сервисов SHOP API, CRM API, MES API, для определения "бутылочных горлышек" в текущей архитектуре.

## (срочно-важно) Инициатива №2: 
Решение проблем монолита MES API. Для этого предлагается вынести функционал расчета стоимости в отдельный бэкенд-сервис и вынести публичный API в отдельный бэкенд-сервис, это позволит легче внедрять изменения в сервисы MES-системы, разгрузить сервис MES API, стабилизировать работу Операторов, клиентов, других продавцов, а так же гибко управлять масштабированием сервисов. Масштабирование данных сервисов в купе с мониторингом, позволит управлять стабильностью работы асинхронного взаимодействия через RabbitMQ между CRM API / MES API.

## (срочно-важно) Инициатива №3: 
Разделить базу данных SHOP DB на SHOP DB и CRM DB. CRM API должен взаимодействовать с SHOP API, это снизит нагрузку на SHOP DB, упростит мониторинг нагрузки баз данных, позволит легче внедрять изменения в сервисы SHOP API и CRM API, решается проблема не консистентности данных, повышается скорость записи и чтения данных.

## (несрочно-важно) Инициатива №4: 
Для внешнего API необходимо применить паттерн отказоустойчивости Curcuit Breaker, для того чтобы внешние пользователи в случае проблем с сервисами не штормили запросами вызывая выедание ресурсов.

## (несрочно-важно) Инициатива №5:
Внедрение системы логирования на все сервисы. Особенно для MES-системы которая является купленной.

## (несрочно-важно) Инициатива №6:
Выстраивание автоматизированного тестирования, встраивание тестирования в CI/CD процессы.

## (несрочно-важно) Инициатива №7:
Обучение или найм тимлида по Java, а так же фронтенд-разработчика React.

## (срочно-неважно) Инициатива №8:
В случае сохранения проблем с прогрузкой первой страницы Операторами MES-системы, внедрение кэширования данных.

## (несрочно-неважно) Инициатива №9: 
Реализация функционала о статусе заказа пользователя.

## (несрочно-неважно) Инициатива №10: 
Автоматизация подтверждения заказа.


# Расставьте инициативы в порядке приоритета

## Видение целевой архитектуры через полгода
DataBase per Service, Observability, Microservice Architecture

## Выбор трех инициатив на ближайшие пол года
Инициативы №1, №2, №3 в соответствии с матрицей (срочно-важно)

